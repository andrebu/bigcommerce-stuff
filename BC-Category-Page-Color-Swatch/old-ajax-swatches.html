<script language="javascript" type="text/javascript">
//Category Page Color Swatches and Size Options
$('<style type="text/css">\
		/* Color and Size Options on Category Pages */\
		.CategoryContent .ProductList li,\
		.SearchContainer .ProductList li {\
			position: relative;\
		}\
		.catColorSwatch {\
			display: inline-block;\
			width: 100%;\
			overflow: hidden;\
			margin-bottom: -13px;\
			visibility: hidden;\
		}\
		.catColorSwatch ul {\
			margin: 0 auto;\
			display: inline-block;\
			overflow: visible;\
			white-space: nowrap;\
		}\
		.catColorSwatch li {\
			padding: 0 4px;\
		}\
		.catColorSwatch .swatchOneColour .validation,\
		.catColorSwatch .swatchOneColour .name,\
		.catColorSwatch .swatchTexture .name,\
		.catSizeSwatch .validation/*,\
		.catSizeSwatch .name*/ {\
			display: none;\
		}\
		.catColorSwatch li .validation {\
			display: none;\
		}\
		.catColorSwatch li,\
		.catColorSwatch li.swatch.swatchTexture,\
		.catColorSwatch li.swatch.swatchOneColour {\
			display: inline-block;\
			width: auto !important;\
			padding: 0;\
			padding: 5px 0 1px;\
			margin-bottom: 0;\
		}\
		.catColorSwatch li.swatch.swatchOneColour.selectedColorBox {\
			padding: 0;\
		}\
		.catColorSwatch li label {\
			margin: 0;\
			line-height: normal;\
			border: 2px solid #d5d5d5;\
			border-radius: 4px;\
			pointer-events: none;\
		}\
		.catColorSwatch li.hovered label {\
			border-color: #666;\
		}\
		.catColorSwatch li.selected label {\
			border-color: #39b54a;\
		}\
		.catColorSwatch li.swatch.swatchOneColour label span.swatchColours.swatchOneColour {\
			line-height: inherit;\
		}\
		.catColorSwatch .swatchColour {\
			display: inline-block;\
			width: 17px !important;\
			border: 1px solid #fff;\
			border-radius: 4px;\
		}\
		.catColorSwatch .name {\
			line-height: 19px;\
			padding: 0 4px;\
		}\
		.catSizeSwatch {\
			background-size: auto 100%;\
			position: absolute;\
			top: 200px;\
			right: 0px;\
			padding: 3px 0;\
			width: 45px;\
		}\
		.catSizeSwatch .list-horizontal {\
			margin: 0;\
		}\
		.catSizeSwatch .list-horizontal .option {\
			display: inline-block;\
			width: 37px !important;\
			padding: 0;\
			background: none;\
            margin: 2px;\
		}\
		.catSizeSwatch .list-horizontal .option label {\
			margin: 0;\
		}\
		.catSizeSwatch .list-horizontal .option label .name {\
		    font-weight: bold;\
		    color: black;\
		    display: block;\
		    font-size: 8px;\
		    line-height: 8px;\
		}\
		.sizeOptionsOverlay {\
			/* background: url("%%ASSET_images/JointSizesL.png%%") center center no-repeat; */\
			background-size: auto 100%;\
			position: absolute;\
			top: 253px;\
			right: 0px;\
			padding: 3px 0;\
			width: 45px;\
		}\
		.catSizeSwatch .jointTitle,\
		.sizeOptionsOverlay .jointTitle {\
		    font-weight: bold;\
			display: inline-block;\
		    line-height: 9px;\
		    font-size: 8px;\
		}\
		.sizeOptionsOverlay .jointSize {\
		    display: inline-block;\
		    text-align: center;\
		    color: #BBB;\
		    vertical-align: bottom;\
		}\
		.catSizeSwatch img,\
		.sizeOptionsOverlay .jointSize img {\
		    width: 14px;\
		    display: block;\
		    margin: 0 auto;\
		    min-height: 20px;\
		}\
		.sizeOptionsOverlay .jointSize span {\
		    font-weight: bold;\
		    color: black;\
		    display: block;\
		    font-size: 8px;\
		}\
		.sizeOptionsOverlay .jointSize i {\
		    display: block;\
		}\
		.catSizeSwatch img.small,\
		.sizeOptionsOverlay .jointSize.small img {\
		    width: 10px;\
		}\
		.catSizeSwatch img.big,\
		.sizeOptionsOverlay .jointSize.big img {\
		    width: 18px;\
		}\
		.catColorSwatch .textureContainer {\
			display: block;\
			width: 20px;\
		}\
		.catColorSwatch .textureContainer .thumbnail,\
		.catColorSwatch .productOptionPickListSwatch .thumbnail {\
			display: block;\
			background-size: 100%;\
			border: 1px solid white;\
			height: 17px;\
		}\
		.MagicScroll:not(.MagicScroll-horizontal):before {\
			visibility: visible;\
			content: "\\f110";\
			color: #39B54A;\
			font: normal normal normal 14px/1 FontAwesome;\
			padding-right: 3px;\
			font-weight: normal;\
			display: inline-block;\
			-webkit-transition: all .3s;\
			-moz-transition: all .3s;\
			-ms-transition: all .3s;\
			-o-transition: all .3s;\
			transition: all .3s;\
			-webkit-transform-origin: 40% center;\
			-moz-transform-origin: 40% center;\
			-ms-transform-origin: 40% center;\
			-o-transform-origin: 40% center;\
			transform-origin: 40% center;\
			-webkit-animation: fa-spin 1s infinite steps(8);\
			animation: fa-spin 1s infinite steps(8);\
			height: inherit;\
			line-height: 30px;\
			position: absolute;\
			left: 17%;\
			z-index: 1;\
		}\
		.MagicScroll:not(.MagicScroll-horizontal):after {\
			visibility: visible;\
			content: "Color Options Loading...";\
			display: block;\
			height: 30px;\
			width: 120px;\
			font-size: 10px;\
			line-height: 30px;\
			text-align: center;\
			position: absolute;\
			top: 0;\
			left: 20%;\
		}\
		@media screen and (device-aspect-ratio: 40/71) {\
			.catSizeSwatch {\
				top: 170px;\
			}\
		}\
		.catColorSwatch .mcs-item {\
			height: 100%;\
			/*width: initial !important;*/\
		}\
		.catColorSwatch .mcs-button-arrow:before {\
			font-size: 150%;\
		}\
		.catColorSwatch .MagicScroll-horizontal .mcs-button-arrow {\
			width: 23px;\
		}\
		.catColorSwatch .MagicScroll-horizontal button.mcs-button.mcs-disabled,\
		.catColorSwatch .MagicScroll-horizontal button.mcs-button.mcs-button-arrow:disabled {\
			display: none !important;\
		}\
		</style>')
    .appendTo('head');

jQuery.expr[':'].icontains = function(a, i, m) {
  return jQuery(a).text().toUpperCase()
      .indexOf(m[3].toUpperCase()) >= 0;
};   

/* try to combine this with category videos! */
function loadColorAndSizeSwatches() {
    // Swatches - Color and Size options swatches 
    $(".ProductActionAdd a:contains('Options')").each(function checkForOptionSwatches(url) {
        var productListing = $(this).closest('em.p-price').html();
        var productLink = $(this).parent().parent().find('div.ProductImage a').attr('href');
        var $this = $(this);

        function getOptionSwatches() {
            return $.ajax({
                url: productLink,
                type: 'GET',
                dataType: 'html',
            });
        }
        getOptionSwatches()
            .done(function(data) {

                result = data;
                var productPage = result;
                var $productPageProcessing = $(productPage).find('.productAttributeList');
                var jointSizeAndGender = $(productPage).find('.JointSizeHeightContainer .Label:icontains("Joint Type:")').parent().find('.Value').text();
                var maleOrFemale = $.trim(jointSizeAndGender).split(' ')[1];
				var colorSwatch = $productPageProcessing.find("span:icontains('Color')").parents().eq(2).find('.productAttributeValue div').html();
				var colorSwatchContent = $('<div class="catColorSwatch optionSwatch">' + colorSwatch + '</div>').fadeIn('slow').css("display","inline-block");
                var sizeSwatch = $productPageProcessing.find("span:icontains('Size')").parents().eq(2).find('.productAttributeValue div').html();
                var sizeOptionsOverlay = $('<div class="catSizeSwatch optionSwatch"><span class="jointTitle">Fits these joint sizes:</span>' + 
                						sizeSwatch + '</div>').fadeIn(1300);
                if (colorSwatch != null) {
					$this.parent().parent().find('.ProductDetails').before(colorSwatchContent);
					$this.parents().eq(1).find('.catColorSwatch ul')
						.addClass('MagicScroll')
						.attr('data-options', 'loop: off; arrows: outside; scrollOnWheel: false; items: [[100,2],[133,3],[166,4],[200,5]];'); 
					$this.addClass('withColorSwatch');
                    // Color swatch clickability Starts here
                    $(".withColorSwatch").each(function() {
	                    var thisColorSwatch = $(this);
                        var productDiv = $(this).parent().parent();
                        var productColorSwatch = productDiv.find('.catColorSwatch');

                        var productName = productDiv.find('.pname').text();
                        var images = [];
                        var productNumber = productDiv.find('.ProductCompareButton .CheckBox').attr('value');

                        // We can pull the color values from the DOM! :)
                        var colors = [];
                        productColorSwatch.find("input.validation").each(function() {
                            colors.push({
                                value: $(this).val(),
                                name: $(this).parent().find("span.swatchColours").attr("title"),
                                url: ''
                            });
                        });

                        var queue = Array.prototype.concat.call(colors); // Make a copy of the array
                        function poll(cb) {
                            // Is queue finished ?
                            if (!queue.length) {
                                cb();
                                return;
                            }

                            // Next color in queue
                            var color = queue.pop();
                            var attributeValue = productColorSwatch.find('.validation').attr('name').replace(/\D/g, '');
                            var args = {
                                action: "add",
                                w: "getProductAttributeDetails",
                                product_id: productNumber,
                                attribute: []
                            };
                            args.attribute[attributeValue] = color.value;

                            $.post("/remote.php", args, function(response) {
                                if (response && response.details && response.details.image) {
                                    result[color.name] = response.details.image;
                                    color.url = response.details.image;
                                }
                                poll(cb); // Next in queue
                            colorSwatchBox.attr('data-src', color.url);
                            });

                            var productImage = productDiv.find('.ProductImage a img');
                            productImage.addClass('colorSwatchImage');
                            var colorSwatchBox = productColorSwatch.find('.validation[value=' + color.value + ']').parent().parent();
                            var activeImage = productImage.attr('src');
                            productImage.attr('data-original', activeImage);
                            function setImgHeight() {
                                var maxImgHeight = productImage.height();
                                productImage.height(maxImgHeight);
                            }
                            setImgHeight();
                        }

                        poll(function() {
                            return;
                        });

                    });
                    // Color swatch clickability ends here
                };
                if (sizeSwatch != null) {
                    var thisProductListing = $this.parent().parent();
                    var maleJointImg = '<img src="%%ASSET_images/malejoint.png%%" />';
                    var femaleJointImg = '<img src="%%ASSET_images/femalejoint.png%%" />';
                    if (maleOrFemale == 'Female') {
                        thisProductListing.find('.ProductDetails').before(sizeOptionsOverlay);
                        thisProductListing.find('.name:icontains("10mm")').text('Male 10mm').after(maleJointImg).addClass('small');
                        thisProductListing.find('.name:icontains("14mm")').text('Male 14mm').after(maleJointImg);
                        thisProductListing.find('.name:icontains("18mm")').text('Male 18mm').after(maleJointImg).addClass('big');
                    };
                    if (maleOrFemale == 'Male') {
                        thisProductListing.find('.ProductDetails').before(sizeOptionsOverlay);
                        thisProductListing.find('.name:icontains("10mm")').text('Female 10mm').after(femaleJointImg).addClass('small');
                        thisProductListing.find('.name:icontains("14mm")').text('Female 14mm').after(femaleJointImg);
                        thisProductListing.find('.name:icontains("18mm")').text('Female 18mm').after(femaleJointImg).addClass('big');
                    };
                };
            }).fail(function() {
                return;
            });
    });
};

function scrollAndAction() {
	var productDiv = $(this).parent().parent();
	var productImage = productDiv.find('.ProductImage a img');
	var originalImage = productImage.attr('data-original');
	MagicScroll.start();
	clickAndHover();
	function clickAndHover() {
		$('li.swatch').on({
			mouseenter: function() {
				originalImage = $(this).parents('li').find('.ProductImage a img').attr('data-original');
				$(this).parents('li').find('.ProductImage a img').attr('src', $(this).attr('data-src'));
				$(this).addClass('hovered');
			},
			mouseleave: function() {
				$(this).removeClass('hovered');
				if (!$(this).hasClass('selected')) {
					$(this).delay(1).parents('li').find('.ProductImage a img').attr('src', originalImage);
				}
			},
			click: function() {
				if ($(this).parents('li').find('.videoDemoBtn.videoPlaying').length > 0) {
				    $(this).parents('li').find('.videoDemoBtn.videoPlaying').click();
				}
				if (!$(this).hasClass('selected')) {
				    $(this).parents().eq(1).find('li.swatch.selected').not(this).removeClass('selected');
				}
				$(this).parents('li').find('.ProductImage a img').attr('src', $(this).attr('data-src'));
				$(this).parents('li').find('.ProductImage a img').attr('data-original', $(this).attr('data-src'));
				$(this).addClass('selected');
			}
		});
	}
}

$(window).load(function() {
	loadColorAndSizeSwatches();
	$(document).ajaxStop(function() {
		scrollAndAction();
	});
});
</script>